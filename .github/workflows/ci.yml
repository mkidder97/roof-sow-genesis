name: 🤖 CI Pipeline with Enhanced Quality Gates

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

env:
  NODE_VERSION: '20'
  CI: true

jobs:
  # Basic health check and setup validation
  setup:
    runs-on: ubuntu-latest
    steps:
      - name: 🔄 Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: 🟢 Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: 📋 Project Structure Check
        run: |
          echo "=== Root Directory ==="
          ls -la
          echo ""
          echo "=== Server Directory ==="
          ls -la server/ || echo "No server directory"
          echo ""
          echo "=== Package.json Files ==="
          find . -name "package.json" -type f
          echo ""
          echo "=== TypeScript Config Files ==="
          find . -name "tsconfig*.json" -type f
        continue-on-error: true

      - name: 📦 Install Root Dependencies
        run: |
          echo "Installing root dependencies..."
          npm ci || npm install
        continue-on-error: true

  # TypeScript Type Checking (MUST PASS)
  type-check:
    runs-on: ubuntu-latest
    needs: setup
    steps:
      - name: 🔄 Checkout
        uses: actions/checkout@v4

      - name: 🟢 Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: 📦 Install Root Dependencies
        run: npm ci

      - name: 📦 Install Server Dependencies
        working-directory: ./server
        run: npm install

      - name: 🔍 TypeScript Check - Root Project
        run: |
          echo "Running TypeScript check for root project..."
          npx tsc --noEmit
          echo "✅ Root project TypeScript check passed"

      - name: 🔍 TypeScript Check - Server Project
        working-directory: ./server
        run: |
          echo "Running TypeScript check for server project..."
          npx tsc --noEmit
          echo "✅ Server project TypeScript check passed"

  # Dedicated Unit Testing (MUST PASS)  
  unit-test:
    runs-on: ubuntu-latest
    needs: setup
    steps:
      - name: 🔄 Checkout
        uses: actions/checkout@v4

      - name: 🟢 Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: 📦 Install Root Dependencies
        run: npm ci

      - name: 🧪 Test API Server Package
        working-directory: ./packages/api-server
        run: |
          echo "Installing api-server package dependencies..."
          npm ci || npm install
          echo "Running api-server unit tests..."
          npx vitest run
          echo "✅ API server unit tests passed"

      - name: 🧪 Test Web Client Package
        working-directory: ./packages/web-client
        run: |
          echo "Installing web-client package dependencies..."
          npm ci || npm install
          echo "Running web-client unit tests..."
          npx vitest run
          echo "✅ Web client unit tests passed"

      - name: 🧪 Run Root Unit Tests
        run: |
          echo "Running root project unit tests..."
          npm run test:unit
          echo "✅ Root unit tests passed"

      - name: 🧪 Run Server Unit Tests
        working-directory: ./server
        run: |
          echo "Installing server dependencies..."
          npm install
          echo "Running server unit tests..."
          npm run test
          echo "✅ Server unit tests passed"

  # Frontend build and lint (MUST PASS)
  frontend:
    runs-on: ubuntu-latest
    needs: [setup, type-check]
    steps:
      - name: 🔄 Checkout
        uses: actions/checkout@v4

      - name: 🟢 Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: 📦 Install Dependencies
        run: npm ci

      - name: 🧹 Lint Frontend
        run: npm run lint

      - name: 🔧 Build Frontend
        run: npm run build

      - name: 📊 Upload Frontend Build
        uses: actions/upload-artifact@v4
        if: success()
        with:
          name: frontend-build
          path: dist/
          retention-days: 1

  # Backend build (MUST PASS)
  backend:
    runs-on: ubuntu-latest
    needs: [setup, type-check]
    steps:
      - name: 🔄 Checkout
        uses: actions/checkout@v4

      - name: 🟢 Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: 🖥️ Setup Chrome for Puppeteer
        uses: browser-actions/setup-chrome@v1

      - name: 📦 Install Root Dependencies
        run: npm ci

      - name: 📦 Install Server Dependencies
        working-directory: ./server
        run: npm install

      - name: 🔧 Build Backend
        working-directory: ./server
        run: npm run build

      - name: 📊 Upload Backend Build
        uses: actions/upload-artifact@v4
        if: success()
        with:
          name: backend-build
          path: server/dist/
          retention-days: 1

  # Smoke Test (MUST PASS)
  smoke-test:
    runs-on: ubuntu-latest
    needs: [frontend, backend, unit-test]
    steps:
      - name: 🔄 Checkout
        uses: actions/checkout@v4

      - name: 🟢 Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: 🖥️ Setup Chrome for Puppeteer
        uses: browser-actions/setup-chrome@v1

      - name: 📦 Install Dependencies
        run: npm ci

      - name: 📦 Install Server Dependencies
        working-directory: ./server
        run: npm install

      - name: 📥 Download Backend Build
        uses: actions/download-artifact@v4
        with:
          name: backend-build
          path: server/dist/

      - name: 🚀 Start API Server
        working-directory: ./server
        run: |
          echo "Starting API server in background..."
          tsx index.ts &
          SERVER_PID=$!
          echo "SERVER_PID=$SERVER_PID" >> $GITHUB_ENV
          
          # Wait for server to start
          echo "Waiting for server to start..."
          for i in {1..30}; do
            if curl -f http://localhost:3001/health >/dev/null 2>&1; then
              echo "✅ Server is responding!"
              break
            fi
            if [ $i -eq 30 ]; then
              echo "❌ Server failed to start within 30 seconds"
              kill $SERVER_PID 2>/dev/null || true
              exit 1
            fi
            echo "Attempt $i/30: Server not ready yet..."
            sleep 2
          done
        env:
          NODE_ENV: test

      - name: 🔍 Test API Health Endpoint
        run: |
          echo "Testing /health endpoint..."
          
          # Test health endpoint
          response=$(curl -s -w "%{http_code}" http://localhost:3001/health)
          http_code=$(echo "$response" | tail -c 4)
          body=$(echo "$response" | head -c -4)
          
          echo "HTTP Status: $http_code"
          echo "Response Body: $body"
          
          if [ "$http_code" != "200" ]; then
            echo "❌ Health check failed with status $http_code"
            exit 1
          fi
          
          echo "✅ Health check passed!"

      - name: 🔍 Test API Basic Endpoints
        run: |
          echo "Testing additional API endpoints..."
          
          # Test root endpoint
          if curl -f http://localhost:3001/ >/dev/null 2>&1; then
            echo "✅ Root endpoint responding"
          else
            echo "⚠️ Root endpoint not responding (may be expected)"
          fi
          
          # Test any other critical endpoints
          echo "✅ Basic endpoint tests completed!"

      - name: 🧪 Run Smoke Test Suite
        run: |
          echo "Running comprehensive smoke tests..."
          npm run test:smoke
          echo "✅ Smoke test suite passed!"

      - name: 🛑 Stop API Server
        if: always()
        run: |
          if [ ! -z "$SERVER_PID" ]; then
            echo "Stopping server (PID: $SERVER_PID)..."
            kill $SERVER_PID 2>/dev/null || true
            sleep 2
            kill -9 $SERVER_PID 2>/dev/null || true
          fi

  # Summary job (ALWAYS RUNS)
  summary:
    runs-on: ubuntu-latest
    needs: [setup, type-check, unit-test, frontend, backend, smoke-test]
    if: always()
    steps:
      - name: 📋 CI Summary
        run: |
          echo "## 🤖 Enhanced CI Pipeline Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status | Notes |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Setup | ${{ needs.setup.result || 'N/A' }} | Project structure validation |" >> $GITHUB_STEP_SUMMARY
          echo "| Type Check | ${{ needs.type-check.result || 'N/A' }} | TypeScript validation (ENFORCED) |" >> $GITHUB_STEP_SUMMARY
          echo "| Unit Tests | ${{ needs.unit-test.result || 'N/A' }} | Package unit testing (ENFORCED) |" >> $GITHUB_STEP_SUMMARY
          echo "| Frontend | ${{ needs.frontend.result || 'N/A' }} | Build and lint (ENFORCED) |" >> $GITHUB_STEP_SUMMARY
          echo "| Backend | ${{ needs.backend.result || 'N/A' }} | Build (ENFORCED) |" >> $GITHUB_STEP_SUMMARY
          echo "| Smoke Test | ${{ needs.smoke-test.result || 'N/A' }} | Integration tests (ENFORCED) |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Count failures and successes
          FAILED_JOBS=""
          SUCCESS_COUNT=0
          
          if [[ "${{ needs.type-check.result }}" == "success" ]]; then
            SUCCESS_COUNT=$((SUCCESS_COUNT + 1))
          elif [[ "${{ needs.type-check.result }}" == "failure" ]]; then
            FAILED_JOBS="$FAILED_JOBS type-check"
          fi
          
          if [[ "${{ needs.unit-test.result }}" == "success" ]]; then
            SUCCESS_COUNT=$((SUCCESS_COUNT + 1))
          elif [[ "${{ needs.unit-test.result }}" == "failure" ]]; then
            FAILED_JOBS="$FAILED_JOBS unit-test"
          fi
          
          if [[ "${{ needs.frontend.result }}" == "success" ]]; then
            SUCCESS_COUNT=$((SUCCESS_COUNT + 1))
          elif [[ "${{ needs.frontend.result }}" == "failure" ]]; then
            FAILED_JOBS="$FAILED_JOBS frontend"
          fi
          
          if [[ "${{ needs.backend.result }}" == "success" ]]; then
            SUCCESS_COUNT=$((SUCCESS_COUNT + 1))
          elif [[ "${{ needs.backend.result }}" == "failure" ]]; then
            FAILED_JOBS="$FAILED_JOBS backend"
          fi
          
          if [[ "${{ needs.smoke-test.result }}" == "success" ]]; then
            SUCCESS_COUNT=$((SUCCESS_COUNT + 1))
          elif [[ "${{ needs.smoke-test.result }}" == "failure" ]]; then
            FAILED_JOBS="$FAILED_JOBS smoke-test"
          fi
          
          if [[ -n "$FAILED_JOBS" ]]; then
            echo "### ❌ Build Failed" >> $GITHUB_STEP_SUMMARY
            echo "Failed jobs:$FAILED_JOBS" >> $GITHUB_STEP_SUMMARY
            echo "Successful jobs: $SUCCESS_COUNT/5" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "#### Quality Gate Requirements:" >> $GITHUB_STEP_SUMMARY
            echo "- **Type Check**: TypeScript compilation without errors" >> $GITHUB_STEP_SUMMARY
            echo "- **Unit Tests**: Package test suites must pass" >> $GITHUB_STEP_SUMMARY
            echo "- **Frontend**: Linting and build success" >> $GITHUB_STEP_SUMMARY
            echo "- **Backend**: Server build process" >> $GITHUB_STEP_SUMMARY
            echo "- **Smoke Test**: End-to-end functionality" >> $GITHUB_STEP_SUMMARY
            exit 1
          else
            echo "### ✅ Build Successful" >> $GITHUB_STEP_SUMMARY
            echo "All $SUCCESS_COUNT quality gates passed! 🎉" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "#### Validated:" >> $GITHUB_STEP_SUMMARY
            echo "- ✅ TypeScript type safety" >> $GITHUB_STEP_SUMMARY
            echo "- ✅ Package unit test coverage" >> $GITHUB_STEP_SUMMARY
            echo "- ✅ Frontend build & lint" >> $GITHUB_STEP_SUMMARY
            echo "- ✅ Backend compilation" >> $GITHUB_STEP_SUMMARY
            echo "- ✅ End-to-end functionality" >> $GITHUB_STEP_SUMMARY
          fi

      - name: ✅ Pipeline Complete
        run: echo "🎉 Enhanced CI pipeline completed with quality gate validation!"
